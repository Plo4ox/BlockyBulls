import{v,w as G,x as H,y as B,A as X,z as Q,C as F,D as $,E as N,F as Z,P as ee,G as T,H as te,n as ae,e as ne,I as re,J as O,K as se,L as W,M as j,N as A,O as oe,s as k,Q as ie,S as P,T as ce,U as de,V as z,W as ue,X as L,Y as pe,Z as le,$ as me,a0 as _,a1 as I,a2 as fe,_ as w,a3 as U}from"./index-883b95b7.js";import{t as ye,p as he}from"./prepare-event-311e153a.js";import{g as ge,v as we}from"./typedData-b5ff9e80.js";function Ae(a){const{domain:e={},message:t,primaryType:n}=a,r={EIP712Domain:ge({domain:e}),...a.types};we({domain:e,message:t,primaryType:n,types:r});const o=["0x1901"];return e&&o.push(ve({domain:e,types:r})),n!=="EIP712Domain"&&o.push(J({data:t,primaryType:n,types:r})),v(G(o))}function ve({domain:a,types:e}){return J({data:a,primaryType:"EIP712Domain",types:e})}function J({data:a,primaryType:e,types:t}){const n=Y({data:a,primaryType:e,types:t});return v(n)}function Y({data:a,primaryType:e,types:t}){const n=[{type:"bytes32"}],r=[_e({primaryType:e,types:t})];for(const o of t[e]){const[s,l]=q({types:t,name:o.name,type:o.type,value:a[o.name]});n.push(s),r.push(l)}return H(n,r)}function _e({primaryType:a,types:e}){const t=B(Oe({primaryType:a,types:e}));return v(t)}function Oe({primaryType:a,types:e}){let t="";const n=K({primaryType:a,types:e});n.delete(a);const r=[a,...Array.from(n).sort()];for(const o of r)t+=`${o}(${e[o].map(({name:s,type:l})=>`${l} ${s}`).join(",")})`;return t}function K({primaryType:a,types:e},t=new Set){const n=a.match(/^\w*/u),r=n==null?void 0:n[0];if(t.has(r)||e[r]===void 0)return t;t.add(r);for(const o of e[r])K({primaryType:o.type,types:e},t);return t}function q({types:a,name:e,type:t,value:n}){if(a[t]!==void 0)return[{type:"bytes32"},v(Y({data:n,primaryType:t,types:a}))];if(t==="bytes")return n=`0x${(n.length%2?"0":"")+n.slice(2)}`,[{type:"bytes32"},v(n)];if(t==="string")return[{type:"bytes32"},v(B(n))];if(t.lastIndexOf("]")===t.length-1){const r=t.slice(0,t.lastIndexOf("[")),o=n.map(s=>q({name:e,type:r,types:a,value:s}));return[{type:"bytes32"},v(H(o.map(([s])=>s),o.map(([,s])=>s)))]}return[{type:t},n]}const C="/docs/contract/decodeEventLog";function xe(a){const{abi:e,data:t,strict:n,topics:r}=a,o=n??!0,[s,...l]=r;if(!s)throw new X({docsPath:C});const c=e.find(d=>d.type==="event"&&s===ye(Q(d)));if(!(c&&"name"in c)||c.type!=="event")throw new F(s,{docsPath:C});const{name:p,inputs:u}=c,y=u==null?void 0:u.some(d=>!("name"in d&&d.name));let i=y?[]:{};const f=u.filter(d=>"indexed"in d&&d.indexed);for(let d=0;d<f.length;d++){const h=f[d],g=l[d];if(!g)throw new $({abiItem:c,param:h});i[y?d:h.name||d]=Te({param:h,value:g})}const m=u.filter(d=>!("indexed"in d&&d.indexed));if(m.length>0){if(t&&t!=="0x")try{const d=N(m,t);if(d)if(y)i=[...i,...d];else for(let h=0;h<m.length;h++)i[m[h].name]=d[h]}catch(d){if(o)throw d instanceof Z||d instanceof ee?new T({abiItem:c,data:t,params:m,size:te(t)}):d}else if(o)throw new T({abiItem:c,data:"0x",params:m,size:0})}return{eventName:p,args:Object.values(i).length>0?i:void 0}}function Te({param:a,value:e}){return a.type==="string"||a.type==="bytes"||a.type==="tuple"||a.type.match(/^(.*)\[(\d+)?\]$/)?e:(N([a],e)||[])[0]}function De({abi:a,eventName:e,logs:t,strict:n=!0}){return t.map(r=>{var o;try{const s=xe({...r,abi:a,strict:n});return e&&!e.includes(s.eventName)?null:{...s,...r}}catch(s){let l,c;if(s instanceof F)return null;if(s instanceof T||s instanceof $){if(n)return null;l=s.abiItem.name,c=(o=s.abiItem.inputs)==null?void 0:o.some(p=>!("name"in p&&p.name))}return{...r,args:c?[]:{},eventName:l}}}).filter(Boolean)}function Ge(a){const{logs:e,events:t,strict:n}=a;return De({logs:e,abi:t.map(r=>r.abiEvent),strict:n})}function Pe(a={}){return he({signature:"event UserOperationRevertReason(bytes32 indexed userOpHash, address indexed sender, uint256 nonce, bytes revertReason)",filters:a})}const be=()=>{const a=BigInt(Math.floor(Math.random()*4294967296)),e=BigInt(Math.floor(Math.random()*4294967296)),t=BigInt(Math.floor(Math.random()*4294967296)),n=BigInt(Math.floor(Math.random()*4294967296)),r=BigInt(Math.floor(Math.random()*4294967296)),o=BigInt(Math.floor(Math.random()*4294967296));return a<<BigInt(160)|e<<BigInt(128)|t<<BigInt(96)|n<<BigInt(64)|r<<BigInt(32)|o},Ee=()=>BigInt(G([ae(be()),"0x0000000000000000"]));function b(a){return Object.fromEntries(Object.entries(a).map(([e,t])=>[e,ne(t)?t:re(t)]))}async function Le(a){var e;return x({...a,operation:"eth_sendUserOperation",params:[b(a.userOp),((e=a.options.overrides)==null?void 0:e.entrypointAddress)??O]})}async function M(a){var t;const e=await x({...a,operation:"eth_estimateUserOperationGas",params:[b(a.userOp),((t=a.options.overrides)==null?void 0:t.entrypointAddress)??O]});return{preVerificationGas:A(e.preVerificationGas),verificationGas:A(e.verificationGas),verificationGasLimit:A(e.verificationGasLimit),callGasLimit:A(e.callGasLimit)+oe}}async function Ie(a){const e=await x({...a,operation:"thirdweb_getUserOperationGasPrice",params:[]});return{maxPriorityFeePerGas:A(e.maxPriorityFeePerGas),maxFeePerGas:A(e.maxFeePerGas)}}async function Ue(a){var t,n;const e=await x({...a,operation:"eth_getUserOperationReceipt",params:[a.userOpHash]});if(e){if(e.success===!1){const o=(n=(t=Ge({events:[Pe()],logs:e.logs})[0])==null?void 0:t.args)==null?void 0:n.revertReason;if(!o)throw new Error(`UserOp failed at txHash: ${e.transactionHash}`);const s=se({data:o});throw new Error(`UserOp failed with reason: '${s.args.join(",")}' at txHash: ${e.transactionHash}`)}return e.receipt}}async function x(a){var c;const{options:e,operation:t,params:n}=a,r=((c=e.overrides)==null?void 0:c.bundlerUrl)??W(e.chain),s=await j(e.client)(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jsonrpc:"2.0",id:1,method:t,params:n})}),l=await s.json();if(!s.ok||l.error){let p=l.error||s.statusText;typeof p=="object"&&(p=JSON.stringify(p));const u=l.code||"UNKNOWN";throw new Error(`${t} error: ${p}
Status: ${s.status}
Code: ${u}`)}return l.result}async function Ce(a,e){var r,o,s;if((r=e.overrides)!=null&&r.predictAddress)return e.overrides.predictAddress(a);if((o=e.overrides)!=null&&o.accountAddress)return e.overrides.accountAddress;const t=e.personalAccountAddress;if(!t)throw new Error("Account address is required to predict the smart wallet address.");const n=k(((s=e.overrides)==null?void 0:s.accountSalt)??"");return ie({contract:a,method:"function getAddress(address, bytes) returns (address)",params:[t,n]})}function Me(a){var n,r;const{factoryContract:e,options:t}=a;return(n=t.overrides)!=null&&n.createAccount?t.overrides.createAccount(e):P({contract:e,method:"function createAccount(address, bytes) returns (address)",params:[t.personalAccount.address,k(((r=t.overrides)==null?void 0:r.accountSalt)??"")]})}function Re(a){var r;const{accountContract:e,options:t,transaction:n}=a;return(r=t.overrides)!=null&&r.execute?t.overrides.execute(e,n):P({contract:e,method:"function execute(address, uint256, bytes)",params:[n.to||"",n.value||0n,n.data||"0x"]})}function Ve(a){var r;const{accountContract:e,options:t,transactions:n}=a;return(r=t.overrides)!=null&&r.executeBatch?t.overrides.executeBatch(e,n):P({contract:e,method:"function executeBatch(address[], uint256[], bytes[])",params:[n.map(o=>o.to||""),n.map(o=>o.value||0n),n.map(o=>o.data||"0x")]})}async function R(a){var y,i,f,m;const{userOp:e,options:t}=a;if((y=t.overrides)!=null&&y.paymaster)return(i=t.overrides)==null?void 0:i.paymaster(e);const n={"Content-Type":"application/json"},r=t.client,o=ce(t.chain),s=((f=t.overrides)==null?void 0:f.entrypointAddress)??O,c=await j(r)(o,{method:"POST",headers:n,body:JSON.stringify({jsonrpc:"2.0",id:1,method:"pm_sponsorUserOperation",params:[b(e),s]})}),p=await c.json();if(!c.ok){const d=p.error||c.statusText,h=p.code||"UNKNOWN";throw new Error(`Paymaster error: ${d}
Status: ${c.status}
Code: ${h}`)}if(p.result)return typeof p.result=="string"?{paymasterAndData:p.result}:{paymasterAndData:p.result.paymasterAndData,verificationGasLimit:p.result.verificationGasLimit?A(p.result.verificationGasLimit):void 0,preVerificationGas:p.result.preVerificationGas?A(p.result.preVerificationGas):void 0,callGasLimit:p.result.callGasLimit?A(p.result.callGasLimit):void 0};const u=((m=p.error)==null?void 0:m.message)||p.error||c.statusText||"unknown error";throw new Error(`Paymaster error from ${o}: ${u}`)}async function Se(a){var y;const{executeTx:e,options:t}=a,r=await de(t.accountContract)?"0x":await Be(t),o=await z(e);let{maxFeePerGas:s,maxPriorityFeePerGas:l}=e;const c=((y=t.overrides)==null?void 0:y.bundlerUrl)??W(t.chain);if(ue(c)){const i=await Ie({options:t});s=i.maxFeePerGas,l=i.maxPriorityFeePerGas}else{const[i,f]=await Promise.all([L(s),L(l)]);if(i&&f)s=i,l=f;else{const m=await pe(t.client,t.chain);l=f??m.maxPriorityFeePerGas??0n,s=i??m.maxFeePerGas??0n}}const p=Ee(),u={sender:t.accountContract.address,nonce:p,initCode:r,callData:o,maxFeePerGas:s,maxPriorityFeePerGas:l,callGasLimit:0n,verificationGasLimit:0n,preVerificationGas:0n,paymasterAndData:"0x",signature:le};if(t.sponsorGas){const i=await R({userOp:u,options:t}),f=i.paymasterAndData;if(f&&f!=="0x"&&(u.paymasterAndData=f),i.callGasLimit&&i.verificationGasLimit&&i.preVerificationGas)u.callGasLimit=i.callGasLimit,u.verificationGasLimit=i.verificationGasLimit,u.preVerificationGas=i.preVerificationGas;else{const m=await M({userOp:u,options:t});if(u.callGasLimit=m.callGasLimit,u.verificationGasLimit=m.verificationGasLimit,u.preVerificationGas=m.preVerificationGas,f&&f!=="0x"){const d=await R({userOp:u,options:t});d.paymasterAndData&&d.paymasterAndData!=="0x"&&(u.paymasterAndData=d.paymasterAndData)}}}else{const i=await M({userOp:u,options:t});u.callGasLimit=i.callGasLimit,u.verificationGasLimit=i.verificationGasLimit,u.preVerificationGas=i.preVerificationGas}return{...u,signature:"0x"}}async function He(a){var r;const{userOp:e,options:t}=a,n=Fe({userOp:e,entryPoint:((r=t.overrides)==null?void 0:r.entrypointAddress)||O,chainId:t.chain.id});if(t.personalAccount.signMessage){const o=await t.personalAccount.signMessage({message:{raw:me(n)}});return{...e,signature:o}}throw new Error("signMessage not implemented in signingAccount")}async function Be(a){const{factoryContract:e}=a,t=Me({factoryContract:e,options:a});return G([e.address,await z(t)])}function Fe(a){const{userOp:e,entryPoint:t,chainId:n}=a,r=_(e.initCode),o=_(e.callData),s=_(e.paymasterAndData),l=I([{type:"address"},{type:"uint256"},{type:"bytes32"},{type:"bytes32"},{type:"uint256"},{type:"uint256"},{type:"uint256"},{type:"uint256"},{type:"uint256"},{type:"bytes32"}],[e.sender,e.nonce,r,o,e.callGasLimit,e.verificationGasLimit,e.preVerificationGas,e.maxFeePerGas,e.maxPriorityFeePerGas,s]),c=I([{type:"bytes32"},{type:"address"},{type:"uint256"}],[_(l),t,BigInt(n)]);return _(c)}function $e(a){return a.id==="smart"}const E=new WeakMap,D=new WeakMap;async function Ne(a,e,t){const{personalAccount:n,client:r,chain:o}=e;if(!n)throw new Error("Personal wallet does not have an account");const s=t,l=s.factoryAddress??fe,c=o??s.chain,p=U({client:r,address:l,chain:c}),u=await Ce(p,{personalAccountAddress:n.address,...s}).then(m=>m).catch(()=>{throw new Error(`Failed to get account address with factory contract ${p.address} on chain ID ${c.id}. Are you on the right chain?`)}),y=U({client:r,address:u,chain:c}),i="gasless"in s?s.gasless:s.sponsorGas,f=await je({...s,chain:c,sponsorGas:i,personalAccount:n,accountContract:y,factoryContract:p,client:r});return E.set(n,a),D.set(a,n),[f,c]}async function We(a){const e=D.get(a);e&&(E.delete(e),D.delete(a))}async function je(a){const{accountContract:e}=a,t={address:e.address,async sendTransaction(n){const r=Re({accountContract:e,options:a,transaction:n});return S({executeTx:r,options:a})},async sendBatchTransaction(n){const r=Ve({accountContract:e,options:a,transactions:n});return S({executeTx:r,options:a})},async signMessage({message:n}){const[{isContractDeployed:r},{readContract:o},{encodeAbiParameters:s},{hashMessage:l},{checkContractWalletSignature:c}]=await Promise.all([w(()=>import("./index-883b95b7.js").then(m=>m.cR),["assets/index-883b95b7.js","assets/index-45a555f8.css"]),w(()=>import("./index-883b95b7.js").then(m=>m.cU),["assets/index-883b95b7.js","assets/index-45a555f8.css"]),w(()=>import("./index-883b95b7.js").then(m=>m.cT),["assets/index-883b95b7.js","assets/index-45a555f8.css"]),w(()=>import("./hashMessage-362d758e.js"),["assets/hashMessage-362d758e.js","assets/index-883b95b7.js","assets/index-45a555f8.css"]),w(()=>import("./checkContractWalletSignature-a1e6d0b1.js"),["assets/checkContractWalletSignature-a1e6d0b1.js","assets/isValidSignature-f3959841.js","assets/index-883b95b7.js","assets/index-45a555f8.css"])]);await r(e)||(console.log("Account contract not deployed yet. Deploying account before signing message"),await V({options:a,account:t,accountContract:e}));const u=l(n);let y=!1;try{await o({contract:e,method:"function getMessageHash(bytes32 _hash) public view returns (bytes32)",params:[u]}),y=!0}catch{}let i;if(y){const m=s([{type:"bytes32"}],[u]);i=await a.personalAccount.signTypedData({domain:{name:"Account",version:"1",chainId:a.chain.id,verifyingContract:e.address},primaryType:"AccountMessage",types:{AccountMessage:[{name:"message",type:"bytes"}]},message:{message:m}})}else i=await a.personalAccount.signMessage({message:n});if(await c({contract:e,message:n,signature:i}))return i;throw new Error("Unable to verify signature on smart account, please make sure the smart account is deployed and the signature is valid.")},async signTypedData(n){var m,d,h;const[{isContractDeployed:r},{readContract:o},{encodeAbiParameters:s},{checkContractWalletSignedTypedData:l}]=await Promise.all([w(()=>import("./index-883b95b7.js").then(g=>g.cR),["assets/index-883b95b7.js","assets/index-45a555f8.css"]),w(()=>import("./index-883b95b7.js").then(g=>g.cU),["assets/index-883b95b7.js","assets/index-45a555f8.css"]),w(()=>import("./index-883b95b7.js").then(g=>g.cT),["assets/index-883b95b7.js","assets/index-45a555f8.css"]),w(()=>import("./checkContractWalletSignedTypedData-67c74ce4.js"),["assets/checkContractWalletSignedTypedData-67c74ce4.js","assets/isValidSignature-f3959841.js","assets/index-883b95b7.js","assets/index-45a555f8.css","assets/prepare-event-311e153a.js","assets/typedData-b5ff9e80.js","assets/regex-88e9c765.js"])]);if(((d=(m=n.domain)==null?void 0:m.verifyingContract)==null?void 0:d.toLowerCase())===((h=e.address)==null?void 0:h.toLowerCase()))return a.personalAccount.signTypedData(n);await r(e)||(console.log("Account contract not deployed yet. Deploying account before signing message"),await V({options:a,account:t,accountContract:e}));const u=Ae(n);let y=!1;try{await o({contract:e,method:"function getMessageHash(bytes32 _hash) public view returns (bytes32)",params:[u]}),y=!0}catch{}let i;if(y){const g=s([{type:"bytes32"}],[u]);i=await a.personalAccount.signTypedData({domain:{name:"Account",version:"1",chainId:a.chain.id,verifyingContract:e.address},primaryType:"AccountMessage",types:{AccountMessage:[{name:"message",type:"bytes"}]},message:{message:g}})}else i=await a.personalAccount.signTypedData(n);if(await l({contract:e,data:n,signature:i}))return i;throw new Error("Unable to verify signature on smart account, please make sure the smart account is deployed and the signature is valid.")}};return t}async function V(a){const{options:e,account:t,accountContract:n}=a,[{sendTransaction:r},{prepareTransaction:o}]=await Promise.all([w(()=>import("./index-883b95b7.js").then(c=>c.cX),["assets/index-883b95b7.js","assets/index-45a555f8.css"]),w(()=>import("./index-883b95b7.js").then(c=>c.cV),["assets/index-883b95b7.js","assets/index-45a555f8.css"])]),s=o({client:e.client,chain:e.chain,to:n.address,value:0n});return await r({transaction:s,account:t})}async function S(a){const{executeTx:e,options:t}=a,n=await Se({executeTx:e,options:t}),r=await He({options:t,userOp:n}),o=await Le({options:t,userOp:r}),s=await ke({options:t,userOpHash:o});return{client:t.client,chain:t.chain,transactionHash:s.transactionHash}}async function ke(a){const{options:e,userOpHash:t}=a,n=12e4,r=1e3,o=Date.now()+n;for(;Date.now()<o;){const s=await Ue({options:e,userOpHash:t});if(s)return s;await new Promise(l=>setTimeout(l,r))}throw new Error("Timeout waiting for userOp to be mined")}const Ke=Object.freeze(Object.defineProperty({__proto__:null,connectSmartWallet:Ne,disconnectSmartWallet:We,isSmartWallet:$e,personalAccountToSmartAccountMap:E},Symbol.toStringTag,{value:"Module"}));export{Ae as h,Ke as i};
